<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Controle de Estoque</title>
    <style>
        .alerta-estoque { background-color: #ffcccc; color: #a60000; font-weight: bold; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        form { margin-bottom: 20px; border: 1px solid #ccc; padding: 10px; }
    </style>
</head>
<body onload="carregarProdutos()">
    <h1>Controle de Estoque</h1>

    <!-- Formulário para NOVO PRODUTO (Exercício 1) -->
    <details>
        <summary><strong>Novo Produto</strong></summary>
        <form id="formNovoProduto">
            Nome: <input type="text" id="nome" required> | 
            Quantidade: <input type="number" id="quantidade_estoque" required> | 
            Estoque Mínimo: <input type="number" id="estoque_minimo" required> | 
            Preço: <input type="number" step="0.01" id="ultimo_preco" required> |
            Validade: <input type="date" id="data_validade"> |
            Descrição: <input type="text" id="descricao">
            <button type="submit">Salvar Novo Produto</button>
        </form>
    </details>

    <!-- Tabela para VISUALIZAR ESTOQUE (Exercício 3) -->
    <h2>Estoque Atual</h2>
    <table>
        <thead>
            <tr>
                <th>Nome</th>
                <th>Quantidade</th>
                <th>Validade</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody id="tabelaEstoque"></tbody>
    </table>

    <!-- Formulário escondido para REGISTRO DE MOVIMENTAÇÕES (Exercício 2) -->
    <div id="divMovimentacao" style="display:none; margin-top: 20px;">
        <h3>Registrar Movimentação</h3>
        <form id="formMovimentacao">
            <input type="hidden" id="mov_id_produto">
            Produto: <strong id="mov_nome_produto"></strong><br><br>
            Nova Quantidade: <input type="number" id="mov_quantidade" required> |
            Novo Preço: <input type="number" step="0.01" id="mov_preco" required> |
            Nova Validade: <input type="date" id="mov_validade">
            <button type="submit">Salvar Alterações</button>
            <button type="button" onclick="fecharMovimentacao()">Cancelar</button>
        </form>
    </div>

    <script>
        // Função principal que carrega e exibe os produtos
        async function carregarProdutos() {
            const response = await fetch('api/produtos.php');
            if (!response.ok) { // Se a sessão expirou, redireciona para o login
                window.location.href = 'login.html';
                return;
            }
            const produtos = await response.json();
            const tabela = document.getElementById('tabelaEstoque');
            tabela.innerHTML = ''; // Limpa a tabela antes de preencher

            produtos.forEach(p => {
                const tr = document.createElement('tr');
                // Aplica a classe de alerta se o estoque estiver baixo (Exercício 3)
                const classeAlerta = p.quantidade_estoque < p.estoque_minimo ? 'alerta-estoque' : '';
                tr.innerHTML = `
                    <td>${p.nome}</td>
                    <td class="${classeAlerta}">${p.quantidade_estoque}</td>
                    <td>${new Date(p.data_validade + 'T00:00:00').toLocaleDateString('pt-BR')}</td>
                    <td><button onclick='abrirMovimentacao(${JSON.stringify(p)})'>Alterar</button></td>
                `;
                tabela.appendChild(tr);
            });
        }

        // Abre o formulário de movimentação com os dados do produto clicado
        function abrirMovimentacao(produto) {
            document.getElementById('mov_id_produto').value = produto.id;
            document.getElementById('mov_nome_produto').innerText = produto.nome;
            document.getElementById('mov_quantidade').value = produto.quantidade_estoque;
            document.getElementById('mov_preco').value = produto.ultimo_preco;
            document.getElementById('mov_validade').value = produto.data_validade;
            document.getElementById('divMovimentacao').style.display = 'block';
        }

        function fecharMovimentacao() {
            document.getElementById('divMovimentacao').style.display = 'none';
        }

        // Envia dados do formulário de NOVO PRODUTO para a API
        document.getElementById('formNovoProduto').addEventListener('submit', async function(e) {
            e.preventDefault();
            const dados = {
                nome: document.getElementById('nome').value,
                descricao: document.getElementById('descricao').value,
                data_validade: document.getElementById('data_validade').value,
                quantidade_estoque: document.getElementById('quantidade_estoque').value,
                estoque_minimo: document.getElementById('estoque_minimo').value,
                ultimo_preco: document.getElementById('ultimo_preco').value,
            };
            await fetch('api/produtos.php', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(dados)
            });
            this.reset();
            carregarProdutos();
        });

        // Envia dados do formulário de MOVIMENTAÇÃO para a API
        document.getElementById('formMovimentacao').addEventListener('submit', async function(e) {
            e.preventDefault();
            const dados = {
                id_produto: document.getElementById('mov_id_produto').value,
                quantidade_estoque: document.getElementById('mov_quantidade').value,
                ultimo_preco: document.getElementById('mov_preco').value,
                data_validade: document.getElementById('mov_validade').value
            };
            await fetch('api/movimentacoes.php', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(dados)
            });
            fecharMovimentacao();
            carregarProdutos();
        });
    </script>
</body>
</html>